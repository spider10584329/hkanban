generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Category {
  id          Int       @id @default(autoincrement())
  manager_id  Int
  name        String    @db.VarChar(100)
  description String?   @db.Text
  icon        String?   @db.VarChar(255)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  products    Product[]

  @@index([manager_id])
  @@index([manager_id, name])
  @@map("categories")
}

model Device {
  id          Int    @id @default(autoincrement())
  manager_id  Int
  mac_address String @db.VarChar(255)
  status      String @db.VarChar(255)

  @@map("device")
}

model OrderItem {
  id                     Int                   @id @default(autoincrement())
  manager_id             Int
  orderId                Int
  productId              Int
  replenishmentRequestId Int?
  quantity               Int
  unitPrice              Decimal?              @db.Decimal(10, 2)
  totalPrice             Decimal?              @db.Decimal(10, 2)
  receivedQuantity       Int?
  damageQuantity         Int?
  notes                  String?               @db.Text
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  order                  Order                 @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product                Product               @relation(fields: [productId], references: [id])
  replenishmentRequest   ReplenishmentRequest? @relation(fields: [replenishmentRequestId], references: [id])

  @@index([manager_id])
  @@index([manager_id, orderId])
  @@index([orderId])
  @@index([productId])
  @@index([replenishmentRequestId])
  @@map("order_items")
}

model Order {
  id               Int         @id @default(autoincrement())
  manager_id       Int
  orderNumber      String      @db.VarChar(50)
  supplierId       Int
  status           String      @db.VarChar(50)
  orderDate        DateTime    @default(now())
  expectedDelivery DateTime?
  actualDelivery   DateTime?
  trackingNumber   String?     @db.VarChar(255)
  trackingUrl      String?     @db.VarChar(500)
  receivedById     Int?
  receivedAt       DateTime?
  receiptNotes     String?     @db.Text
  totalAmount      Decimal?    @db.Decimal(10, 2)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  orderItems       OrderItem[]
  receivedBy       User?       @relation(fields: [receivedById], references: [id])
  supplier         Supplier    @relation(fields: [supplierId], references: [id])

  @@unique([manager_id, orderNumber], map: "unique_manager_ordernumber")
  @@index([manager_id])
  @@index([manager_id, orderDate])
  @@index([manager_id, status])
  @@index([receivedById])
  @@index([supplierId])
  @@map("orders")
}

model Product {
  id                    Int                    @id @default(autoincrement())
  manager_id            Int
  name                  String                 @db.VarChar(255)
  description           String?                @db.Text
  sku                   String?                @db.VarChar(100)
  categoryId            Int
  supplierId            Int?
  location              String                 @db.VarChar(255) 
  reorderThreshold      Int?
  standardOrderQty      Int?
  unitPrice             Decimal?               @db.Decimal(10, 2)
  qrCodeUrl             String?                @db.VarChar(500)
  qrCodeImagePath       String?                @db.VarChar(500)
  einkDeviceId          String?                @db.VarChar(100)
  hasEinkDevice         Int                    @default(0) @db.TinyInt
  isActive              Int                    @default(1) @db.TinyInt
  minewSynced           Int                    @default(0) @db.TinyInt
  minewSyncedAt         DateTime?
  minewGoodsId          String?                @db.VarChar(255)
  minewSyncError        String?                @db.Text
  minewBoundLabel       String?                @db.VarChar(100)
  minewBoundAt          DateTime?
  createdById           Int?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime
  orderItems            OrderItem[]
  category              Category               @relation(fields: [categoryId], references: [id])
  createdBy             User?                  @relation(fields: [createdById], references: [id])
  supplier              Supplier?              @relation(fields: [supplierId], references: [id])
  replenishmentRequests ReplenishmentRequest[]

  @@unique([manager_id, einkDeviceId], map: "unique_manager_eink")
  @@unique([manager_id, qrCodeUrl], map: "unique_manager_qrcode")
  @@unique([manager_id, sku], map: "unique_manager_sku")
  @@index([categoryId], map: "products_categoryId_fkey")
  @@index([createdById])
  @@index([manager_id, categoryId])
  @@index([manager_id])
  @@index([manager_id, isActive])
  @@index([manager_id, supplierId])
  @@index([supplierId], map: "products_supplierId_fkey")
  @@map("products")
}

model ReplenishmentRequest {
  id              Int         @id @default(autoincrement())
  manager_id      Int
  productId       Int
  requestedById   Int
  requestMethod   String      @db.VarChar(20)
  deviceInfo      String?     @db.VarChar(255)
  requestedQty    Int?
  location        String      @db.VarChar(255)
  notes           String?     @db.Text
  status          String      @db.VarChar(50)
  priority        String      @default("NORMAL") @db.VarChar(20)
  approvedById    Int?
  approvedAt      DateTime?
  rejectionReason String?     @db.Text
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  completedAt     DateTime?
  orderItems      OrderItem[]
  approvedBy      User?       @relation("ApprovedRequests", fields: [approvedById], references: [id])
  product         Product     @relation(fields: [productId], references: [id])
  requestedBy     User        @relation("CreatedRequests", fields: [requestedById], references: [id])

  @@index([approvedById])
  @@index([manager_id, createdAt])
  @@index([manager_id])
  @@index([manager_id, productId])
  @@index([manager_id, status])
  @@index([productId])
  @@index([requestedById])
  @@map("replenishment_requests")
}

model StockHistory {
  id         Int      @id @default(autoincrement())
  manager_id Int
  productId  Int
  eventType  String   @db.VarChar(50)
  quantity   Int
  userId     Int?
  orderId    Int?
  requestId  Int?
  notes      String?  @db.Text
  timestamp  DateTime @default(now())

  @@index([manager_id, eventType])
  @@index([manager_id])
  @@index([manager_id, productId])
  @@index([manager_id, timestamp])
  @@index([productId])
  @@map("stock_history")
}

model Supplier {
  id          Int       @id @default(autoincrement())
  manager_id  Int
  name        String    @db.VarChar(255)
  contactName String?   @db.VarChar(255)
  phone       String?   @db.VarChar(50)
  email       String?   @db.VarChar(255)
  address     String?   @db.Text
  isActive    Int       @default(1) @db.TinyInt
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  orders      Order[]
  products    Product[]

  @@index([manager_id])
  @@index([manager_id, isActive])
  @@map("suppliers")
}

model ApiKey {
  id         Int    @id @default(autoincrement())
  manager_id Int
  api_key    String @db.VarChar(255)
  created_at String @db.VarChar(255)

  @@map("apikey")
}

model Gateway {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  mac_address String   @db.VarChar(20)
  manager_id  Int
  created_at  DateTime @default(now())

  @@unique([manager_id, mac_address], map: "unique_manager_mac")
  @@index([manager_id])
  @@map("gateway")
}

model User {
  id                    Int                    @id @default(autoincrement())
  manager_id            Int
  username              String                 @unique(map: "username") @db.VarChar(255)
  password              String                 @db.VarChar(255)
  isActive              Int?                   @default(0) @db.TinyInt
  passwordRequest       String?                @db.VarChar(255)
  isPasswordRequest     Int?                   @default(0) @db.TinyInt
  receivedOrders        Order[]
  createdProducts       Product[]
  approvedRequests      ReplenishmentRequest[] @relation("ApprovedRequests")
  replenishmentRequests ReplenishmentRequest[] @relation("CreatedRequests")

  @@map("users")
}

model MinewTokenCache {
  id               Int      @id @default(autoincrement())
  token            String   @db.Text
  expiresAt        DateTime
  lastRefreshedAt  DateTime
  username         String   @db.VarChar(255)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([expiresAt])
  @@index([username])
  @@map("minew_token_cache")
}

model MinewConfig {
  id           Int      @id @default(autoincrement())
  configKey    String   @unique @db.VarChar(255)
  configValue  String   @db.Text
  description  String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([configKey])
  @@map("minew_config")
}

model MinewSyncQueue {
  id           Int      @id @default(autoincrement())
  entityType   String   @db.VarChar(50) // 'product', 'order', 'device'
  entityId     Int
  operation    String   @db.VarChar(50) // 'create', 'update', 'delete'
  payload      String   @db.Text // JSON string
  retryCount   Int      @default(0)
  maxRetries   Int      @default(3)
  lastError    String?  @db.Text
  status       String   @default("pending") @db.VarChar(50) // 'pending', 'processing', 'success', 'failed'
  scheduledAt  DateTime
  processedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status, scheduledAt])
  @@index([entityType, entityId])
  @@map("minew_sync_queue")
}
